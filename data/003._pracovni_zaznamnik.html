<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSM - Centrální záznamník</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Základní styly pro vysoký kontrast a lepší čitelnost */
        body {
            background-color: #000;
            font-family: 'Inter', sans-serif;
            color: #fff;
            padding: 2rem;
        }
        .container {
            max-width: 5xl; /* Větší kontejner pro více obsahu */
            margin: 0 auto;
            padding: 2rem;
            background-color: #1a1a1a;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #facc15;
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin-bottom: 2rem;
        }
        h2 {
            color: #facc15;
            font-size: 1.75rem;
            font-weight: bold;
            margin-top: 1.5rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #555;
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 1rem;
        }
        h2 button {
            margin: 0;
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            background-color: #4a4a4a;
            color: #fff;
            white-space: nowrap;
        }
        h2 button:hover {
            background-color: #6a6a6a;
        }
        /* Styly pro tlačítka */
        button {
            padding: 0.75rem 1.5rem;
            margin: 0.5rem;
            border: none;
            font-weight: bold;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .btn-primary { background-color: #4caf50; color: #fff; }
        .btn-secondary { background-color: #facc15; color: #000; }
        .btn-danger { background-color: #f44336; color: #fff; }
        .btn-export { background-color: #ff9800; color: #000; }
        .btn-import { background-color: #ffc107; color: #000; }
        .btn-toggle-form { background-color: #6200ea; color: #fff; }
        .btn-filter { background-color: #03a9f4; color: #fff; }
        .btn-back { background-color: #4a4a4a; color: #fff; }
        
        button:hover { opacity: 0.9; }
        button:focus { outline: 2px solid #facc15; outline-offset: 2px; }

        /* Styly pro formuláře a inputy */
        .form-section {
            background-color: #222;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        input[type="text"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            padding: 0.75rem;
            width: 100%;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            border: 1px solid #555;
            background-color: #333;
            color: #fff;
            box-sizing: border-box;
        }
        textarea { height: 120px; resize: vertical; }
        label { margin-bottom: 0.5rem; display: block; color: #ccc; }
        .hidden { display: none; }

        /* Styly pro tabulku */
        table {
            border-collapse: collapse;
            width: 100%;
            background: #111;
            color: #fff;
            margin-top: 1.5rem;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        th, td {
            border: 1px solid #333;
            padding: 0.75rem;
            text-align: left;
        }
        th {
            background: #222;
            font-weight: bold;
            color: #facc15;
            cursor: pointer;
            position: relative;
        }
        th.sorted-asc::after {
            content: " ▲";
            position: absolute;
            right: 0.5rem;
        }
        th.sorted-desc::after {
            content: " ▼";
            position: absolute;
            right: 0.5rem;
        }
        tr:nth-child(even) { background-color: #1a1a1a; }
        tr:hover { background-color: #2a2a2a; }

        /* Styly pro modální okna */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #2d3748;
            color: #e2e8f0;
            margin: auto;
            padding: 20px;
            border: 1px solid #4a5568;
            width: 80%;
            max-width: 500px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.4),0 6px 20px 0 rgba(0,0,0,0.3);
            text-align: center;
        }
        .modal-buttons {
            text-align: right;
        }
        .modal-buttons button {
            padding: 0.5rem 1rem;
            margin-left: 0.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .modal-buttons .bg-gray-500 { background-color: #4a4a4a; color: #fff; }
        .modal-buttons .bg-red-500 { background-color: #f44336; color: #fff; }

        /* Specifické styly pro typy úkolů/položek v tabulce */
        .item-type-note { color: #8d8dff; }
        .item-type-todo_list { color: #4caf50; }
        .item-type-event { color: #ff9800; }
        .item-type-idea { color: #f44336; }

        /* To-Do specifické styly */
        .todo-completed { text-decoration: line-through; color: #888; }
        .todo-priority-nízká { color: #ccc; }
        .todo-priority-střední { color: #facc15; }
        .todo-priority-vysoká { color: #f44336; font-weight: bold; }
        
        /* Odkaz zpět na Dashboard */
        .back-to-dashboard-link {
            display: block;
            width: fit-content;
            background-color: #4a4a4a;
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            text-decoration: none;
            font-weight: bold;
            margin-bottom: 1.5rem;
            transition: background-color 0.2s ease;
        }
        .back-to-dashboard-link:hover {
            background-color: #6a6a6a;
        }
        .back-to-dashboard-link:focus {
            outline: 2px solid #facc15;
            outline-offset: 2px;
        }
        /* Styly pro input typu file */
        label.file-input-label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            margin: 0.5rem;
            border: none;
            font-weight: bold;
            cursor: pointer;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
            color: #000;
            background-color: #ffc107;
        }
        label.file-input-label:hover {
            opacity: 0.9;
        }
        label.file-input-label input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="../index.html" class="back-to-dashboard-link" aria-label="Zpět na JSM">← Zpět na JSM</a>

        <h1 id="mainTitle">Centrální záznamník</h1>

        <div class="flex items-center justify-between mb-6" id="globalControls">
            <button class="btn-export" onclick="exportAllData()">Exportovat vše (JSON)</button>
            <label class="ml-4 btn-import">
                Importovat vše (JSON):
                <input type="file" onchange="importAllData(event)" accept=".json" aria-label="Vybrat soubor pro import dat"/>
            </label>
        </div>

        <div class="flex flex-wrap justify-center mb-6" id="addButtonsSection">
            <button class="btn-toggle-form" onclick="toggleForm('noteFormSection')" aria-controls="noteFormSection" aria-expanded="false">Přidat poznámku</button>
            <button class="btn-toggle-form" onclick="toggleForm('todoListFormSection')" aria-controls="todoListFormSection" aria-expanded="false">Přidat To-Do List</button>
            <button class="btn-toggle-form" onclick="toggleForm('eventFormSection')" aria-controls="eventFormSection" aria-expanded="false">Přidat událost</button>
            <button class="btn-toggle-form" onclick="toggleForm('ideaFormSection')" aria-controls="ideaFormSection" aria-expanded="false">Přidat nápad</button>
        </div>

        <div id="noteFormSection" class="form-section hidden">
            <h2>Přidat poznámku</h2>
            <label for="noteTitle">Název poznámky:</label>
            <input type="text" id="noteTitle" placeholder="Např. Důležité poznámky ze školení" aria-label="Název poznámky" />
            
            <label for="noteClientSelect" class="mt-4">Přidat ke klientovi (nepovinné):</label>
            <select id="noteClientSelect" class="w-full">
                <option value="">-- Vyberte klienta --</option>
            </select>
            
            <label for="noteText">Text poznámky:</label>
            <textarea id="noteText" placeholder="Sem napište text poznámky..." aria-label="Text poznámky"></textarea>
            <button class="btn-primary" onclick="addNote()">Přidat poznámku</button>
        </div>

        <div id="todoListFormSection" class="form-section hidden">
            <h2>Přidat nový To-Do List</h2>
            <label for="newListName">Název listu:</label>
            <input type="text" id="newListName" placeholder="Např. Práce, Osobní, Nákup" aria-label="Název To-Do listu" />
            <button class="btn-primary" onclick="addTodoList()">Vytvořit list</button>
        </div>

        <div id="todoFormSection" class="form-section hidden">
            <h2>Přidat úkol do listu</h2>
            
            <label for="taskClientSelect" class="mt-4">Přidat ke klientovi (nepovinné):</label>
            <select id="taskClientSelect" class="w-full">
                <option value="">-- Vyberte klienta --</option>
            </select>
            
            <label for="taskText">Popis úkolu:</label>
            <input type="text" id="taskText" placeholder="Např. Zavolat dodavateli ohledně oleje" aria-label="Popis úkolu" />
            <label for="taskDueDate">Termín (datum):</label>
            <input type="date" id="taskDueDate" aria-label="Termín úkolu" />
            <label for="taskPriority">Priorita:</label>
            <select id="taskPriority" aria-label="Priorita úkolu">
                <option value="nízká">Nízká</option>
                <option value="střední">Střední</option>
                <option value="vysoká">Vysoká</option>
            </select>
            <button class="btn-primary" onclick="addTask()">Přidat úkol</button>
        </div>
        
        <div id="eventFormSection" class="form-section hidden">
            <h2>Přidat událost</h2>
            
            <label for="eventClientSelect" class="mt-4">Přidat ke klientovi (nepovinné):</label>
            <select id="eventClientSelect" class="w-full">
                <option value="">-- Vyberte klienta --</option>
            </select>

            <label for="eventDate">Datum události:</label>
            <input type="date" id="eventDate" aria-label="Datum události" />
            <label for="eventTime">Čas události:</label>
            <input type="time" id="eventTime" aria-label="Čas události" />
            <label for="eventTitle">Název události:</label>
            <input type="text" id="eventTitle" placeholder="Např. Endokrinologie kontrola" aria-label="Název události" />
            <label for="eventDescription">Popis události / Poznámky:</label>
            <textarea id="eventDescription" placeholder="Detailní popis události..." aria-label="Popis události"></textarea>
            <button class="btn-primary" onclick="addEvent()">Přidat událost</button>
        </div>

        <div id="ideaFormSection" class="form-section hidden">
            <h2>Přidat nápad</h2>
            <label for="ideaTitle">Název nápadu:</label>
            <input type="text" id="ideaTitle" placeholder="Např. Nová služba pro klienty" aria-label="Název nápadu" />

            <label for="ideaClientSelect" class="mt-4">Přidat ke klientovi (nepovinné):</label>
            <select id="ideaClientSelect" class="w-full">
                <option value="">-- Vyberte klienta --</option>
            </select>

            <label for="ideaDescription">Popis nápadu / detailní poznámky:</label>
            <textarea id="ideaDescription" placeholder="Rozveďte svůj nápad..." aria-label="Popis nápadu"></textarea>
            <label for="ideaCategory">Kategorie nápadu:</label>
            <select id="ideaCategory" aria-label="Kategorie nápadu">
                <option value="Obecné">Obecné</option>
                <option value="Marketing">Marketing</option>
                <option value="Služby">Nové služby</option>
                <option value="Studio">Vylepšení studia</option>
                <option value="AI">AI a technologie</option>
                <option value="Ostatní">Ostatní</option>
            </select>
            <button class="btn-primary" onclick="addIdea()">Přidat nápad</button>
        </div>

        <div class="filter-section">
            <label for="globalFilterInput" class="sr-only">Filtruj záznamy:</label>
            <input type="text" id="globalFilterInput" placeholder="Filtruj záznamy (název, popis, termín, kategorie...)" oninput="updateTable()" aria-label="Filtrovat záznamy" />
            <button class="btn-filter" onclick="clearFilter()">Zrušit filtr</button>
        </div>
        
        <div class="flex flex-wrap justify-center my-4 gap-2">
            <button class="btn-toggle-filter" data-filter="all">Všechny</button>
            <button class="btn-toggle-filter" data-filter="note">Poznámky</button>
            <button class="btn-toggle-filter" data-filter="todo_list">Úkoly</button>
            <button class="btn-toggle-filter" data-filter="event">Události</button>
            <button class="btn-toggle-filter" data-filter="idea">Nápady</button>
        </div>

        <table id="mainDataTable">
            <thead>
                <tr>
                    <th scope="col" data-sort="type">Typ</th>
                    <th scope="col" data-sort="clientName">Klient</th>
                    <th scope="col" data-sort="title">Název/Popis</th>
                    <th scope="col">Detail/Termín</th>
                    <th scope="col" data-sort="category">Kategorie/Priorita</th>
                    <th scope="col">Akce</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>

        <div id="customMessageModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalMessageTitle" tabindex="-1">
            <div class="modal-content">
                <h3 id="modalMessageTitle" class="text-xl font-bold text-yellow-300 mb-4">Zpráva</h3>
                <p id="modalMessage" class="text-gray-300 mb-4"></p>
                <div class="modal-buttons">
                    <button id="modalOkButton" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-md">OK</button>
                    <button id="modalCancelButton" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md ml-2 hidden">Zrušit</button>
                </div>
            </div>
        </div>

        <div id="ideaActionsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="ideaActionsTitle" tabindex="-1">
            <div class="modal-content">
                <h3 id="ideaActionsTitle" class="text-xl font-bold text-yellow-300 mb-4">Nápad byl přidán. Co dál?</h3>
                <p id="ideaActionsText" class="text-gray-300 mb-4">Máte nové možnosti pro tento nápad:</p>
                <div class="modal-buttons flex justify-center gap-4 mt-6">
                    <button id="addIdeaToPricelistBtn" class="btn-primary">Přidat do ceníku v Masérně</button>
                    <button id="addIdeaToTodoBtn" class="btn-secondary">Přidat jako úkol</button>
                    <button id="closeIdeaActionsModalBtn" class="btn-back">Hotovo</button>
                </div>
            </div>
        </div>
        
        <div id="todoListDetailSection" class="hidden container-fluid bg-gray-900 p-8 rounded-lg shadow-lg text-left text-gray-200 mb-12">
            <a href="#" onclick="goBackToMainView()" class="back-to-dashboard-link mb-6">← Zpět na hlavní přehled</a>
            <h2 id="currentTodoListName"></h2>
            <div id="todoListTasksTableContainer">
                <table id="todoListTasksTable">
                    <thead>
                        <tr>
                            <th scope="col">Splněno</th>
                            <th scope="col">Klient</th>
                            <th scope="col" data-sort="text">Popis úkolu</th>
                            <th scope="col" data-sort="dueDate">Termín</th>
                            <th scope="col" data-sort="priority">Priorita</th>
                            <th scope="col">Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            <div class="text-center mt-6">
                <button class="btn-primary" onclick="showAddTodoTaskForm()">Přidat nový úkol do listu</button>
            </div>
        </div>

    <script>
        // Hlavní datová struktura pro všechny typy záznamů
        let data = {
            notes: [],
            todos: [],
            events: [],
            ideas: []
        };
        let masernaClients = []; // Pole pro uložení klientů z Masérny
        
        // --- Začátek kódu pro práci s IndexDB ---
        const DB_NAME = 'jsmZaznamnikDB';
        const DB_VERSION = 1;
        let db;

        const MASERNA_DB_NAME = 'jsmMasernaDB';
        const MASERNA_DB_VERSION = 1;

        /**
         * Otevře IndexedDB databázi. Pokud neexistuje, vytvoří ji a vytvoří object store.
         * @returns {Promise<IDBDatabase>} Vrátí Promise s databázovým objektem.
         */
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('zaznamnikData')) {
                        db.createObjectStore('zaznamnikData', { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    db = event.target.result;
                    console.log('IndexedDB databáze JSM-Záznamník byla úspěšně otevřena.');
                    resolve(db);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB chyba:", event.target.error);
                    showCustomModal('Nepodařilo se otevřít databázi. Data nebudou automaticky ukládána.', 'Chyba databáze');
                    reject(event.target.error);
                };
            });
        }

        /**
         * Načte data z databáze a nahradí jimi aktuální globální proměnnou 'data'.
         * @returns {Promise<void>}
         */
        async function loadDataFromDB() {
            if (!db) {
                await openDatabase();
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['zaznamnikData'], 'readonly');
                const store = transaction.objectStore('zaznamnikData');
                const request = store.get('currentData');

                request.onsuccess = (event) => {
                    if (request.result) {
                        data = request.result.data;
                        console.log('Data byla úspěšně načtena z lokálního úložiště.');
                    }
                    resolve();
                };

                request.onerror = (event) => {
                    console.error("Chyba při čtení z databáze:", event.target.error);
                    reject(event.target.error);
                };
            });
        }
        
        /**
         * Uloží aktuální globální data do IndexedDB.
         */
        function saveDataToDB() {
            if (!db) {
                console.error("Databáze není otevřena.");
                return;
            }
            const transaction = db.transaction(['zaznamnikData'], 'readwrite');
            const store = transaction.objectStore('zaznamnikData');
            const dataToSave = {
                id: 'currentData',
                data: data
            };
            store.put(dataToSave);
            console.log('Data byla automaticky uložena.');
        }

        /**
         * Automatické ukládání dat po každé změně.
         */
        function autoSave() {
            saveDataToDB();
        }
        
        // --- Nová funkce pro načítání klientů z Masérny ---
        async function loadClientsFromMasernaDB() {
            return new Promise((resolve, reject) => {
                const masernaRequest = indexedDB.open(MASERNA_DB_NAME, MASERNA_DB_VERSION);

                masernaRequest.onsuccess = (event) => {
                    const masernaDB = event.target.result;
                    const transaction = masernaDB.transaction(['masernaData'], 'readonly');
                    const store = transaction.objectStore('masernaData');
                    
                    const getRequest = store.get('currentData');
                    
                    getRequest.onsuccess = () => {
                        const masernaData = getRequest.result ? getRequest.result.data : { clients: [] };
                        masernaClients = masernaData.clients.map(client => ({
                            id: client.id,
                            name: client.name
                        }));
                        populateClientSelects();
                        console.log('Klienti z Masérny úspěšně načteni.');
                        resolve();
                    };

                    getRequest.onerror = (event) => {
                        console.error('Chyba při načítání klientů z Masérny:', event.target.error);
                        resolve(); // Ponecháme to, ať to neblokuje aplikaci, když se klienti nenačtou
                    };
                };

                masernaRequest.onerror = (event) => {
                    console.error('Nepodařilo se otevřít databázi Masérny:', event.target.error);
                    resolve();
                };
            });
        }

        /**
         * Naplní rozbalovací menu pro výběr klienta.
         */
        function populateClientSelects() {
            const selects = document.querySelectorAll('select[id$="ClientSelect"]');
            selects.forEach(select => {
                // Zachováme původní volbu pro případ, že tam už něco bylo
                const originalValue = select.value;
                select.innerHTML = '<option value="">-- Vyberte klienta --</option>'; 
                masernaClients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = client.name;
                    select.appendChild(option);
                });
                select.value = originalValue;
            });
        }

        /**
         * Získá jméno klienta podle ID.
         * @param {string} clientId ID klienta.
         * @returns {string} Jméno klienta, nebo 'Neznámý klient'.
         */
        function getClientNameById(clientId) {
            const client = masernaClients.find(c => c.id === clientId);
            return client ? client.name : 'Neznámý klient';
        }

        // --- Konec kódu pro práci s IndexDB ---
        
        let pendingConfirmCallback = null;
        let currentFilter = 'all';
        let currentView = 'main';
        let currentTodoListId = null;
        let lastFocusedElement = null;
        let sortStates = {};

        const typeIcons = {
            'note': '📝',
            'todo_list': '✅',
            'event': '🗓️',
            'idea': '💡'
        };

        const typeColors = {
            'note': 'text-blue-300',
            'todo_list': 'text-green-400',
            'event': 'text-orange-400',
            'idea': 'text-red-400'
        };

        /**
         * Zobrazí modální okno s vlastní zprávou.
         * @param {string} message Zpráva k zobrazení.
         * @param {string} title Titulek modálního okna.
         * @param {Function} [onConfirm=null] Callback funkce pro potvrzení.
         * @param {boolean} [showCancel=false] Zda zobrazit tlačítko "Zrušit".
         */
        function showCustomModal(message, title = 'Zpráva', onConfirm = null, showCancel = false) {
            lastFocusedElement = document.activeElement;
            const modal = document.getElementById('customMessageModal');
            document.getElementById('modalMessageTitle').textContent = title;
            document.getElementById('modalMessage').innerHTML = message;
            
            const okButton = document.getElementById('modalOkButton');
            const cancelButton = document.getElementById('modalCancelButton');

            pendingConfirmCallback = onConfirm;
            cancelButton.style.display = showCancel ? 'inline-block' : 'none';
            
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');
            setTimeout(() => {
                modal.focus();
            }, 100);
        }

        /**
         * Zavře modální okno.
         */
        function closeCustomModal() {
            const modal = document.getElementById('customMessageModal');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            if (lastFocusedElement) {
                lastFocusedElement.focus();
            }
            pendingConfirmCallback = null;
        }

        /**
         * Zavře modální okno s daným ID.
         * @param {string} modalId ID modálního okna.
         */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                modal.setAttribute('aria-hidden', 'true');
                if (lastFocusedElement) {
                    lastFocusedElement.focus();
                }
            }
        }

        function handleModalKeyboard(event) {
            if (event.key === 'Escape') {
                closeCustomModal();
            }
        }

        /**
         * Převede datum z formátu YYYY-MM-DD na DD.MM.YYYY.
         * @param {string} dateString Datum v YYYY-MM-DD.
         * @returns {string} Datum v DD.MM.YYYY.
         */
        function formatDateForInput(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('.');
            if (parts.length === 3) {
                return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            }
            return dateString;
        }

        /**
         * Převede datum z formátu YYYY-MM-DD na DD.MM.YYYY.
         * @param {string} dateString Datum v YYYY-MM-DD.
         * @returns {string} Datum v DD.MM.YYYY.
         */
        function parseDateFromInput(dateString) {
            if (!dateString) return '';
            const parts = dateString.split('-');
            if (parts.length === 3) {
                return `${parts[2]}.${parts[1]}.${parts[0]}`;
            }
            return dateString;
        }

        /**
         * Převede datum z formátu YYYY-MM-DD na DD.MM.YYYY.
         * @param {string} dateString Datum v YYYY-MM-DD.
         * @returns {string} Datum v DD.MM.YYYY.
         */
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            const [year, month, day] = dateString.split('-');
            return `${day}.${month}.${year}`;
        }

        let activeFormId = null;
        /**
         * Přepíná viditelnost formulářů.
         * @param {string} formId ID formuláře.
         */
        function toggleForm(formId) {
            const targetForm = document.getElementById(formId);
            const buttons = document.querySelectorAll('.btn-toggle-form');

            if (activeFormId === formId) {
                targetForm.classList.add('hidden');
                document.querySelector(`button[aria-controls="${formId}"]`).setAttribute('aria-expanded', 'false');
                activeFormId = null;
            } else {
                document.querySelectorAll('.form-section').forEach(form => {
                    if (form.id !== formId) {
                        form.classList.add('hidden');
                        document.querySelector(`button[aria-controls="${form.id}"]`)?.setAttribute('aria-expanded', 'false');
                    }
                });

                targetForm.classList.remove('hidden');
                document.querySelector(`button[aria-controls="${formId}"]`).setAttribute('aria-expanded', 'true');
                activeFormId = formId;

                targetForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                targetForm.querySelector('input, textarea, select, button')?.focus();
            }
        }

        /**
         * Přidá novou poznámku.
         */
        function addNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const clientId = document.getElementById('noteClientSelect').value.trim();
            const text = document.getElementById('noteText').value.trim();

            if (!title || !text) { showCustomModal('Prosím, vyplňte název i text poznámky.', 'Chyba'); return; }
            data.notes.push({ id: Date.now(), type: 'note', title: title, text: text, clientId: clientId || null });
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteText').value = '';
            document.getElementById('noteClientSelect').value = '';
            updateTable();
            toggleForm('noteFormSection');
            autoSave();
        }

        /**
         * Zobrazí detail poznámky.
         * @param {number} id ID poznámky.
         */
        function viewNote(id) {
            const note = data.notes.find(n => n.id === id);
            showCustomModal(`
                <p class="modal-text"><strong>Text:</strong> ${note.text.replace(/\n/g, '<br>')}</p>
            `, `Poznámka: ${note.title}`, null, false);
        }

        /**
         * Otevře modální okno pro úpravu poznámky.
         * @param {number} id ID poznámky.
         */
        function editNote(id) {
            const note = data.notes.find(n => n.id === id);
            showCustomModal(`
                <label for="editNoteTitle">Název poznámky:</label>
                <input type="text" id="editNoteTitle" value="${note.title}" placeholder="Název poznámky" /><br>
                <label for="editNoteClientSelect" class="mt-4">Přidat ke klientovi (nepovinné):</label>
                <select id="editNoteClientSelect" class="w-full">
                    <option value="">-- Vyberte klienta --</option>
                </select>
                <label for="editNoteText">Text poznámky:</label>
                <textarea id="editNoteText" placeholder="Poznámka">${note.text}</textarea>
            `, 'Upravit poznámku', () => { submitEditNote(id); }, true);
            populateClientSelects();
            document.getElementById('editNoteClientSelect').value = note.clientId || '';
        }

        /**
         * Uloží upravenou poznámku.
         * @param {number} id ID poznámky.
         */
        function submitEditNote(id) {
            const note = data.notes.find(n => n.id === id);
            note.title = document.getElementById('editNoteTitle').value.trim();
            note.clientId = document.getElementById('editNoteClientSelect').value.trim() || null;
            note.text = document.getElementById('editNoteText').value.trim();
            closeCustomModal();
            updateTable();
            autoSave();
        }

        /**
         * Zobrazí detaily To-Do listu.
         * @param {number} listId ID To-Do listu.
         */
        function showTodoListDetails(listId) {
            currentView = 'todoListDetail';
            currentTodoListId = listId;
            
            document.getElementById('globalControls').classList.add('hidden');
            document.getElementById('addButtonsSection').classList.add('hidden');
            document.getElementById('globalFilterInput').classList.add('hidden');
            document.querySelector('.filter-section button').classList.add('hidden');
            document.querySelector('.btn-toggle-filter').parentElement.classList.add('hidden');
            document.getElementById('mainDataTable').classList.add('hidden');
            
            const list = data.todos.find(l => l.id === listId);
            document.getElementById('currentTodoListName').textContent = `Úkoly v listu: ${list ? list.name : ''}`;
            document.getElementById('todoListDetailSection').classList.remove('hidden');
            
            updateTasksTable();
            toggleForm('todoFormSection');
            document.getElementById('taskText').focus();
        }

        /**
         * Přepne zpět na hlavní zobrazení.
         */
        function goBackToMainView() {
            currentView = 'main';
            currentTodoListId = null;

            document.getElementById('globalControls').classList.remove('hidden');
            document.getElementById('addButtonsSection').classList.remove('hidden');
            document.getElementById('globalFilterInput').classList.remove('hidden');
            document.querySelector('.filter-section button').classList.remove('hidden');
            document.querySelector('.btn-toggle-filter').parentElement.classList.remove('hidden');
            document.getElementById('mainDataTable').classList.remove('hidden');

            document.getElementById('todoListDetailSection').classList.add('hidden');
            document.getElementById('todoFormSection').classList.add('hidden');
            
            updateTable();
        }
        
        /**
         * Přidá nový To-Do list.
         */
        function addTodoList() {
            const listName = document.getElementById('newListName').value.trim();
            if (!listName) { showCustomModal('Prosím, zadejte název To-Do listu.', 'Chyba'); return; }
            data.todos.push({ id: Date.now(), type: 'todo_list', name: listName, tasks: [] });
            document.getElementById('newListName').value = '';
            updateTable();
            toggleForm('todoListFormSection');
            autoSave();
        }

        /**
         * Zobrazí formulář pro přidání úkolu do listu.
         */
        function showAddTodoTaskForm() {
            toggleForm('todoFormSection');
            document.getElementById('taskText').focus();
        }

        /**
         * Přidá nový úkol do aktuálního To-Do listu.
         */
        function addTask() {
            const clientId = document.getElementById('taskClientSelect').value.trim();
            const text = document.getElementById('taskText').value.trim();
            const dueDate = document.getElementById('taskDueDate').value;
            const priority = document.getElementById('taskPriority').value;

            if (!text) { showCustomModal('Prosím, vyplňte popis úkolu.', 'Chyba'); return; }
            if (currentTodoListId === null) { showCustomModal('Nejdříve musíte vybrat nebo vytvořit To-Do list.', 'Chyba'); return; }

            const list = data.todos.find(l => l.id === currentTodoListId);
            if (list) {
                list.tasks.push({ 
                    id: Date.now(), 
                    type: 'todo_task', 
                    text: text, 
                    dueDate: dueDate, 
                    priority: priority, 
                    completed: false, 
                    clientId: clientId || null 
                });
                document.getElementById('taskText').value = '';
                document.getElementById('taskDueDate').value = '';
                document.getElementById('taskPriority').value = 'nízká';
                document.getElementById('taskClientSelect').value = '';
                updateTasksTable();
                toggleForm('todoFormSection');
                autoSave();
            }
        }

        /**
         * Přepne stav dokončení úkolu.
         * @param {number} taskId ID úkolu.
         */
        function toggleTaskCompletionInList(taskId) {
            const list = data.todos.find(l => l.id === currentTodoListId);
            if (list) {
                const task = list.tasks.find(t => t.id === taskId);
                if (task) {
                    task.completed = !task.completed;
                    updateTasksTable();
                    autoSave();
                }
            }
        }

        /**
         * Otevře modální okno pro úpravu úkolu.
         * @param {number} taskId ID úkolu.
         */
        function editTaskInList(taskId) {
            const list = data.todos.find(l => l.id === currentTodoListId);
            if (!list) return;
            const task = list.tasks.find(t => t.id === taskId);
            if (!task) return;
            
            showCustomModal(`
                <label for="editTaskClientSelect" class="mt-4">Přidat ke klientovi (nepovinné):</label>
                <select id="editTaskClientSelect" class="w-full">
                    <option value="">-- Vyberte klienta --</option>
                </select>
                <label for="editTaskText">Popis úkolu:</label>
                <input type="text" id="editTaskText" value="${task.text}" placeholder="Popis úkolu" /><br>
                <label for="editTaskDueDate">Termín (datum):</label>
                <input type="date" id="editTaskDueDate" value="${task.dueDate}" /><br>
                <label for="editTaskPriority">Priorita:</label>
                <select id="editTaskPriority">
                    <option value="nízká" ${task.priority === 'nízká' ? 'selected' : ''}>Nízká</option>
                    <option value="střední" ${task.priority === 'střední' ? 'selected' : ''}>Střední</option>
                    <option value="vysoká" ${task.priority === 'vysoká' ? 'selected' : ''}>Vysoká</option>
                </select>
            `, 'Upravit úkol', () => { submitEditTaskInList(taskId); }, true);
            populateClientSelects();
            document.getElementById('editTaskClientSelect').value = task.clientId || '';
        }

        /**
         * Uloží upravený úkol.
         * @param {number} taskId ID úkolu.
         */
        function submitEditTaskInList(taskId) {
            const list = data.todos.find(l => l.id === currentTodoListId);
            if (!list) return;
            const task = list.tasks.find(t => t.id === taskId);
            if (!task) return;

            task.clientId = document.getElementById('editTaskClientSelect').value.trim() || null;
            task.text = document.getElementById('editTaskText').value.trim();
            task.dueDate = document.getElementById('editTaskDueDate').value;
            task.priority = document.getElementById('editTaskPriority').value;
            closeCustomModal();
            updateTasksTable();
            autoSave();
        }

        /**
         * Smaže úkol.
         * @param {number} taskId ID úkolu.
         */
        function deleteTaskInList(taskId) {
            confirmAndDeleteItem('todo_task', taskId, currentTodoListId);
        }
        
        /**
         * Obsluhuje navigaci klávesnicí v tabulce úkolů.
         * @param {Event} event Událost klávesy.
         * @param {number} taskId ID úkolu.
         */
        function handleTaskTableKeydown(event, taskId) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                toggleTaskCompletionInList(taskId);
                event.target.focus();
            } else if (event.key === 'ArrowUp' || event.key === 'ArrowDown') {
                event.preventDefault();
                const currentRow = event.target.closest('tr');
                let newRow;
                if (event.key === 'ArrowUp') {
                    newRow = currentRow.previousElementSibling;
                } else {
                    newRow = currentRow.nextElementSibling;
                }
                if (newRow) {
                    newRow.querySelector('input[type="checkbox"]').focus();
                }
            }
        }

        /**
         * Aktualizuje tabulku s úkoly v detailním zobrazení.
         */
        function updateTasksTable() {
            const tbody = document.querySelector('#todoListTasksTable tbody'); 
            tbody.innerHTML = '';
            
            const list = data.todos.find(l => l.id === currentTodoListId);
            if (!list) return; 

            const sortKey = sortStates['todoListTasksTable'] ? sortStates['todoListTasksTable'].key : 'dueDate';
            const sortDirection = sortStates['todoListTasksTable'] ? sortStates['todoListTasksTable'].direction : 'asc';

            const tasks = [...list.tasks].sort((a, b) => {
                if (a.completed !== b.completed) return a.completed ? 1 : -1;
                
                let valA, valB;
                const priorityOrder = { 'vysoká': 3, 'střední': 2, 'nízká': 1 };
                
                if (sortKey === 'priority') {
                    valA = priorityOrder[a.priority] || 0;
                    valB = priorityOrder[b.priority] || 0;
                } else if (sortKey === 'dueDate') {
                    valA = a.dueDate ? a.dueDate : '9999-12-31';
                    valB = b.dueDate ? b.dueDate : '9999-12-31';
                } else {
                    valA = a[sortKey].toLowerCase();
                    valB = b[sortKey].toLowerCase();
                }

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            tasks.forEach(task => {
                const row = document.createElement('tr');
                const completedClass = task.completed ? 'todo-completed' : '';
                const priorityClass = `todo-priority-${task.priority}`;
                
                row.innerHTML = `
                    <td class="${completedClass}">
                        <input type="checkbox" id="task-${task.id}" ${task.completed ? 'checked' : ''} tabindex="0" onclick="toggleTaskCompletionInList(${task.id})">
                    </td>
                    <td class="${completedClass}">${task.clientId ? getClientNameById(task.clientId) : '---'}</td>
                    <td class="${completedClass}"><label for="task-${task.id}" class="cursor-pointer">${task.text}</label></td>
                    <td class="${completedClass}">${formatDateForDisplay(task.dueDate)}</td>
                    <td class="${completedClass} ${priorityClass}">${task.priority}</td>
                    <td>
                        <button class="btn-secondary" onclick="editTaskInList(${task.id})">Upravit</button>
                        <button class="btn-danger" onclick="deleteTaskInList(${task.id})">Smazat</button>
                        <button class="btn-export" onclick="exportItemToTxt('todo_task', ${task.id})">Export TXT</button>
                    </td>
                `;
                const checkbox = row.querySelector(`#task-${task.id}`);
                if (checkbox) {
                    checkbox.addEventListener('keydown', (event) => handleTaskTableKeydown(event, task.id));
                }
                tbody.appendChild(row);
            });
        }

        /**
         * Otevře modální okno pro úpravu názvu To-Do listu.
         * @param {number} listId ID To-Do listu.
         */
        function editTodoListName(listId) {
            const list = data.todos.find(l => l.id === listId);
            if (!list) return;

            showCustomModal(`
                <label for="editListName">Název listu:</label>
                <input type="text" id="editListName" value="${list.name}" placeholder="Název listu" /><br>
            `, 'Upravit název To-Do listu', () => { submitEditTodoListName(listId); }, true);
        }

        /**
         * Uloží upravený název To-Do listu.
         * @param {number} listId ID To-Do listu.
         */
        function submitEditTodoListName(listId) {
            const list = data.todos.find(l => l.id === listId);
            if (!list) return;
            list.name = document.getElementById('editListName').value.trim();
            closeCustomModal();
            updateTable();
            autoSave();
        }

        /**
         * Přidá novou událost.
         */
        function addEvent() {
            const clientId = document.getElementById('eventClientSelect').value.trim();
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const title = document.getElementById('eventTitle').value.trim();
            const description = document.getElementById('eventDescription').value.trim();

            if (!date || !time || !title) { showCustomModal('Prosím, vyplňte Datum, Čas a Název události.', 'Chyba'); return; }
            data.events.push({ id: Date.now(), type: 'event', date: date, time: time, title: title, description: description, clientId: clientId || null });
            document.getElementById('eventClientSelect').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            updateTable();
            toggleForm('eventFormSection');
            autoSave();
        }

        /**
         * Zobrazí detail události.
         * @param {number} id ID události.
         */
        function viewEvent(id) {
            const event = data.events.find(e => e.id === id);
            showCustomModal(`
                <p class="modal-text"><strong>Datum:</strong> ${formatDateForDisplay(event.date)}</p>
                <p class="modal-text"><strong>Čas:</strong> ${event.time}</p>
                <p class="modal-text"><strong>Popis:</strong> ${event.description.replace(/\n/g, '<br>')}</p>
            `, `Událost: ${event.title}`, null, false);
        }

        /**
         * Otevře modální okno pro úpravu události.
         * @param {number} id ID události.
         */
        function editEvent(id) {
            const event = data.events.find(e => e.id === id);
            showCustomModal(`
                <label for="editEventClientSelect" class="mt-4">Přidat ke klientovi (nepovinné):</label>
                <select id="editEventClientSelect" class="w-full">
                    <option value="">-- Vyberte klienta --</option>
                </select>
                <label for="editEventDate">Datum události:</label>
                <input type="date" id="editEventDate" value="${event.date}" /><br>
                <label for="editEventTime">Čas události:</label>
                <input type="time" id="editEventTime" value="${event.time}" /><br>
                <label for="editEventTitle">Název události:</label>
                <input type="text" id="editEventTitle" value="${event.title}" placeholder="Název události" /><br>
                <label for="editEventDescription">Popis události / Poznámky:</label>
                <textarea id="editEventDescription" placeholder="Popis události / Poznámky">${event.description}</textarea>
            `, 'Upravit událost', () => { submitEditEvent(id); }, true);
            populateClientSelects();
            document.getElementById('editEventClientSelect').value = event.clientId || '';
        }

        /**
         * Uloží upravenou událost.
         * @param {number} id ID události.
         */
        function submitEditEvent(id) {
            const event = data.events.find(e => e.id === id);
            event.clientId = document.getElementById('editEventClientSelect').value.trim() || null;
            event.date = document.getElementById('editEventDate').value;
            event.time = document.getElementById('editEventTime').value;
            event.title = document.getElementById('editEventTitle').value.trim();
            event.description = document.getElementById('editEventDescription').value.trim();
            closeCustomModal();
            updateTable();
            autoSave();
        }

        /**
         * Přidá nový nápad.
         */
        function addIdea() {
            const title = document.getElementById('ideaTitle').value.trim();
            const clientId = document.getElementById('ideaClientSelect').value.trim();
            const description = document.getElementById('ideaDescription').value.trim();
            const category = document.getElementById('ideaCategory').value;

            if (!title || !description) { showCustomModal('Prosím, vyplňte název i popis nápadu.', 'Chyba'); return; }
            
            const newIdea = { id: Date.now(), type: 'idea', title: title, description: description, category: category, clientId: clientId || null };
            data.ideas.push(newIdea);
            
            document.getElementById('ideaTitle').value = '';
            document.getElementById('ideaDescription').value = '';
            document.getElementById('ideaCategory').value = 'Obecné';
            document.getElementById('ideaClientSelect').value = '';

            updateTable();
            toggleForm('ideaFormSection');
            autoSave();
            
            // Zobrazení kontextového okna s akcemi
            showIdeaActionsModal(newIdea);
        }

        /**
         * Zobrazí detail nápadu.
         * @param {number} id ID nápadu.
         */
        function viewIdea(id) {
            const idea = data.ideas.find(i => i.id === id);
            showCustomModal(`
                <p class="modal-text"><strong>Popis:</strong> ${idea.description.replace(/\n/g, '<br>')}</p>
            `, `Nápad: ${idea.title} (${idea.category})`, null, false);
        }

        /**
         * Otevře modální okno pro úpravu nápadu.
         * @param {number} id ID nápadu.
         */
        function editIdea(id) {
            const idea = data.ideas.find(i => i.id === id);
            showCustomModal(`
                <label for="editIdeaTitle">Název nápadu:</label>
                <input type="text" id="editIdeaTitle" value="${idea.title}" placeholder="Název nápadu" /><br>
                <label for="editIdeaClientSelect" class="mt-4">Přidat ke klientovi (nepovinné):</label>
                <select id="editIdeaClientSelect" class="w-full">
                    <option value="">-- Vyberte klienta --</option>
                </select>
                <label for="editIdeaDescription">Popis nápadu / detailní poznámky:</label>
                <textarea id="editIdeaDescription" placeholder="Popis nápadu / detailní poznámky">${idea.description}</textarea><br>
                <label for="editIdeaCategory">Kategorie nápadu:</label>
                <select id="editIdeaCategory">
                    <option value="Obecné" ${idea.category === 'Obecné' ? 'selected' : ''}>Obecné</option>
                    <option value="Marketing" ${idea.category === 'Marketing' ? 'selected' : ''}>Marketing</option>
                    <option value="Služby" ${idea.category === 'Služby' ? 'selected' : ''}>Nové služby</option>
                    <option value="Studio" ${idea.category === 'Studio' ? 'selected' : ''}>Vylepšení studia</option>
                    <option value="AI" ${idea.category === 'AI' ? 'selected' : ''}>AI a technologie</option>
                    <option value="Ostatní" ${idea.category === 'Ostatní' ? 'selected' : ''}>Ostatní</option>
                </select>
            `, 'Upravit nápad', () => { submitEditIdea(id); }, true);
            populateClientSelects();
            document.getElementById('editIdeaClientSelect').value = idea.clientId || '';
        }

        /**
         * Uloží upravený nápad.
         * @param {number} id ID nápadu.
         */
        function submitEditIdea(id) {
            const idea = data.ideas.find(i => i.id === id);
            idea.title = document.getElementById('editIdeaTitle').value.trim();
            idea.clientId = document.getElementById('editIdeaClientSelect').value.trim() || null;
            idea.description = document.getElementById('editIdeaDescription').value.trim();
            idea.category = document.getElementById('editIdeaCategory').value;
            closeCustomModal();
            updateTable();
            autoSave();
        }
        
        /**
         * Filtruje záznamy podle typu.
         * @param {string} type Typ záznamu k zobrazení ('all', 'note', 'todo_list', 'event', 'idea').
         */
        function filterByType(type) {
            currentFilter = type;
            document.querySelectorAll('.btn-toggle-filter').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            });
            const activeBtn = document.querySelector(`.btn-toggle-filter[data-filter="${type}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-700', 'text-gray-300');
                activeBtn.classList.add('bg-blue-600', 'text-white');
            }
            updateTable();
        }

        /**
         * Zobrazí potvrzovací okno před smazáním záznamu.
         * @param {string} type Typ záznamu.
         * @param {number} id ID záznamu.
         * @param {number} [todoListId=null] ID To-Do listu (pouze pro úkoly).
         */
        function confirmAndDeleteItem(type, id, todoListId = null) {
            showCustomModal('Opravdu chcete odstranit tento záznam?', 'Potvrdit smazání', () => {
                doDeleteItem(type, id, todoListId);
            }, true);
        }

        /**
         * Provede smazání záznamu po potvrzení.
         * @param {string} type Typ záznamu.
         * @param {number} id ID záznamu.
         * @param {number} [todoListId=null] ID To-Do listu (pouze pro úkoly).
         */
        function doDeleteItem(type, id, todoListId = null) {
            if (type === 'todo_task' && todoListId !== null) {
                const list = data.todos.find(list => list.id === todoListId);
                if (list) {
                    list.tasks = list.tasks.filter(task => task.id !== id);
                    updateTasksTable();
                }
            } else {
                if (type === 'todo_list') {
                    data.todos = data.todos.filter(item => item.id !== id);
                } else {
                    data[`${type}s`] = data[`${type}s`].filter(item => item.id !== id);
                }
            }
            closeCustomModal();
            updateTable();
            autoSave();
        }

        /**
         * Třídí tabulku.
         * @param {string} tableId ID tabulky.
         * @param {string} sortKey Klíč pro třídění.
         */
        function sortTable(tableId, sortKey) {
            const table = document.getElementById(tableId);
            const headers = table.querySelectorAll('th[data-sort]');
            
            headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
            
            const currentHeader = table.querySelector(`th[data-sort="${sortKey}"]`);

            if (!sortStates[tableId] || sortStates[tableId].key !== sortKey) {
                sortStates[tableId] = { key: sortKey, direction: 'asc' };
            } else {
                sortStates[tableId].direction = sortStates[tableId].direction === 'asc' ? 'desc' : 'asc';
            }
            
            currentHeader.classList.add(`sorted-${sortStates[tableId].direction}`);

            if (tableId === 'todoListTasksTable') {
                updateTasksTable();
            } else {
                updateTable();
            }
        }
        
        /**
         * Aktualizuje hlavní tabulku na základě filtru a zobrazení.
         */
        function updateTable() {
            if (currentView === 'todoListDetail') {
                updateTasksTable();
                return;
            }

            const tbody = document.querySelector('#mainDataTable tbody');
            tbody.innerHTML = '';
            const filterInput = document.getElementById('globalFilterInput').value.toLowerCase();

            let allItems = [];
            if (currentFilter === 'all' || currentFilter === 'note') {
                allItems = allItems.concat(data.notes.map(n => ({ ...n, displayType: 'Poznámka' })));
            }
            if (currentFilter === 'all' || currentFilter === 'todo_list') {
                allItems = allItems.concat(data.todos.map(list => ({ 
                    id: list.id, 
                    type: 'todo_list', 
                    name: list.name, 
                    taskCount: list.tasks.length, 
                    displayType: 'To-Do List' 
                })));
            }
            if (currentFilter === 'all' || currentFilter === 'event') {
                allItems = allItems.concat(data.events.map(e => ({ ...e, displayType: 'Událost' })));
            }
            if (currentFilter === 'all' || currentFilter === 'idea') {
                allItems = allItems.concat(data.ideas.map(i => ({ ...i, displayType: 'Nápad' })));
            }

            const filteredItems = allItems.filter(item => {
                const searchable = (item.title || item.text || item.name || '') + ' ' +
                                   (item.description || '') + ' ' +
                                   (item.category || '') + ' ' +
                                   (item.priority || '') + ' ' +
                                   (item.dueDate || item.date || '') + ' ' +
                                   (item.time || '');
                return searchable.toLowerCase().includes(filterInput);
            });
            
            const sortKey = sortStates['mainDataTable'] ? sortStates['mainDataTable'].key : 'type';
            const sortDirection = sortStates['mainDataTable'] ? sortStates['mainDataTable'].direction : 'asc';
            
            const finalSortedItems = filteredItems.sort((a, b) => {
                let valA, valB;

                if (sortKey === 'type') {
                    valA = a.type.toLowerCase();
                    valB = b.type.toLowerCase();
                } else if (sortKey === 'title') {
                    valA = (a.title || a.name || '').toLowerCase();
                    valB = (b.title || b.name || '').toLowerCase();
                } else if (sortKey === 'category') {
                    valA = (a.category || a.priority || '').toLowerCase();
                    valB = (b.category || b.priority || '').toLowerCase();
                } else if (sortKey === 'clientName') {
                    valA = getClientNameById(a.clientId).toLowerCase();
                    valB = getClientNameById(b.clientId).toLowerCase();
                } else {
                    valA = (a.date || a.dueDate || '').toLowerCase();
                    valB = (b.date || b.dueDate || '').toLowerCase();
                }

                if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });


            finalSortedItems.forEach(item => {
                const row = document.createElement('tr');
                let cell1 = '', cell2 = '', cell3 = '', cell4 = '', cell5 = '', actionButtons = ''; 

                switch (item.type) {
                    case 'note':
                        cell1 = `<span class="item-type-note">${typeIcons.note} ${item.displayType}</span>`;
                        cell2 = item.clientId ? getClientNameById(item.clientId) : '---';
                        cell3 = `<button class="text-left" onclick="viewNote(${item.id})">${item.title}</button>`;
                        cell4 = item.text.substring(0, 50) + (item.text.length > 50 ? '...' : '');
                        cell5 = '---';
                        actionButtons = `
                            <button class="btn-secondary" onclick="editItem('${item.type}', ${item.id})">Upravit</button>
                            <button class="btn-danger" onclick="confirmAndDeleteItem('${item.type}', ${item.id})">Smazat</button>
                            <button class="btn-export" onclick="exportItemToTxt('${item.type}', ${item.id})">Export TXT</button>
                        `;
                        break;
                    case 'todo_list':
                        cell1 = `<span class="item-type-todo_list">${typeIcons.todo_list} ${item.displayType}</span>`;
                        cell2 = '---';
                        cell3 = `<button class="text-left" onclick="showTodoListDetails(${item.id})">${item.name}</button>`;
                        cell4 = `${item.taskCount} úkolů`;
                        cell5 = '---';
                        actionButtons = `
                            <button class="btn-secondary" onclick="editTodoListName(${item.id})">Upravit</button>
                            <button class="btn-danger" onclick="confirmAndDeleteItem('todo_list', ${item.id})">Smazat</button>
                        `;
                        break;
                    case 'event':
                        cell1 = `<span class="item-type-event">${typeIcons.event} ${item.displayType}</span>`;
                        cell2 = item.clientId ? getClientNameById(item.clientId) : '---';
                        cell3 = `<button class="text-left" onclick="viewEvent(${item.id})">${item.title}</button>`;
                        cell4 = `${formatDateForDisplay(item.date)} ${item.time}`;
                        cell5 = item.description.substring(0, 50) + (item.description.length > 50 ? '...' : '');
                        actionButtons = `
                            <button class="btn-secondary" onclick="editItem('${item.type}', ${item.id})">Upravit</button>
                            <button class="btn-danger" onclick="confirmAndDeleteItem('${item.type}', ${item.id})">Smazat</button>
                            <button class="btn-export" onclick="exportItemToTxt('${item.type}', ${item.id})">Export TXT</button>
                        `;
                        break;
                    case 'idea':
                        cell1 = `<span class="item-type-idea">${typeIcons.idea} ${item.displayType}</span>`;
                        cell2 = item.clientId ? getClientNameById(item.clientId) : '---';
                        cell3 = `<button class="text-left" onclick="viewIdea(${item.id})">${item.title}</button>`;
                        cell4 = item.description.substring(0, 50) + (item.description.length > 50 ? '...' : '');
                        cell5 = item.category;
                        actionButtons = `
                            <button class="btn-secondary" onclick="editItem('${item.type}', ${item.id})">Upravit</button>
                            <button class="btn-danger" onclick="confirmAndDeleteItem('${item.type}', ${item.id})">Smazat</button>
                            <button class="btn-export" onclick="exportItemToTxt('${item.type}', ${item.id})">Export TXT</button>
                        `;
                        break;
                }

                row.innerHTML = `
                    <td>${cell1}</td>
                    <td>${cell2}</td>
                    <td>${cell3}</td>
                    <td>${cell4}</td>
                    <td>${cell5}</td>
                    <td>${actionButtons}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        /**
         * Volá správnou editační funkci na základě typu.
         * @param {string} type Typ záznamu.
         * @param {number} id ID záznamu.
         */
        function editItem(type, id) {
            switch (type) {
                case 'note': editNote(id); break;
                case 'todo_list': editTodoListName(id); break;
                case 'todo_task': editTaskInList(id); break;
                case 'event': editEvent(id); break;
                case 'idea': editIdea(id); break;
            }
        }

        /**
         * Exportuje záznam do TXT souboru.
         * @param {string} type Typ záznamu.
         * @param {number} id ID záznamu.
         */
        function exportItemToTxt(type, id) {
            let item, content = '';
            let filename = 'zaznam';

            switch (type) {
                case 'note':
                    item = data.notes.find(n => n.id === id);
                    if (!item) return;
                    content = `--- Poznámka ---\nNázev: ${item.title}\nKlient: ${item.clientId ? getClientNameById(item.clientId) : '---'}\nText: ${item.text}\n`;
                    filename = item.title;
                    break;
                case 'todo_task':
                    const list = data.todos.find(l => l.tasks.some(t => t.id === id));
                    item = list ? list.tasks.find(t => t.id === id) : null;
                    if (!item) return;
                    content = `--- Úkol (To-Do) ---\nList: ${list.name}\nKlient: ${item.clientId ? getClientNameById(item.clientId) : '---'}\nPopis: ${item.text}\nTermín: ${formatDateForDisplay(item.dueDate)}\nPriorita: ${item.priority}\nSplněno: ${item.completed ? 'Ano' : 'Ne'}\n`;
                    filename = item.text;
                    break;
                case 'event':
                    item = data.events.find(e => e.id === id);
                    if (!item) return;
                    content = `--- Událost ---\nNázev: ${item.title}\nKlient: ${item.clientId ? getClientNameById(item.clientId) : '---'}\nDatum: ${formatDateForDisplay(item.date)}\nČas: ${item.time}\nPopis: ${item.description}\n`;
                    filename = item.title;
                    break;
                case 'idea':
                    item = data.ideas.find(i => i.id === id);
                    if (!item) return;
                    content = `--- Nápad/Inspirace ---\nNázev: ${item.title}\nKlient: ${item.clientId ? getClientNameById(item.clientId) : '---'}\nKategorie: ${item.category}\nPopis: ${item.description}\n`;
                    filename = item.title;
                    break;
                default: return;
            }
            
            filename = filename.replace(/[^a-z0-9]/gi, '_').toLowerCase();

            const dataStr = "data:text/plain;charset=utf-8," + encodeURIComponent(content);
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", `${filename}_${type}_${id}.txt`);
            dl.click();
        }

        /**
         * Vymaže globální filtr a aktualizuje tabulku.
         */
        function clearFilter() {
            document.getElementById('globalFilterInput').value = '';
            currentFilter = 'all';
            document.querySelectorAll('.btn-toggle-filter').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            });
            const allBtn = document.querySelector(`.btn-toggle-filter[data-filter="all"]`);
            if (allBtn) {
                allBtn.classList.remove('bg-gray-700', 'text-gray-300');
                allBtn.classList.add('bg-blue-600', 'text-white');
            }
            updateTable();
        }

        /**
         * Exportuje všechna data do JSON souboru.
         */
        function exportAllData() {
            try {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
                const dl = document.createElement('a');
                dl.setAttribute("href", dataStr);
                dl.setAttribute("download", "centralni_zaznamnik.json");
                dl.click();
                showCustomModal("Všechna data osobního záznamníku byla úspěšně exportována jako JSON.", "Export dokončen");
            } catch (error) {
                console.error("Chyba při exportu JSON dat:", error);
                showCustomModal("Nastala chyba při exportu dat. Zkuste to prosím znovu.", 'Chyba exportu');
            }
        }

        /**
         * Importuje data ze JSON souboru a ukládá je do IndexedDB.
         * @param {Event} event Událost importu souboru.
         */
        function importAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async e => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData && typeof importedData === 'object' &&
                        'notes' in importedData && Array.isArray(importedData.notes) &&
                        'todos' in importedData && Array.isArray(importedData.todos) &&
                        'events' in importedData && Array.isArray(importedData.events) &&
                        'ideas' in importedData && Array.isArray(importedData.ideas)) {
                        
                        importedData.notes.forEach(item => item.id = Number(item.id) || Date.now());
                        importedData.todos.forEach(list => {
                            list.id = Number(list.id) || Date.now();
                            list.tasks.forEach(task => {
                                task.id = Number(task.id) || Date.now();
                                task.completed = (task.completed === true);
                                if (typeof task.dueDate !== 'string') task.dueDate = '';
                                if (typeof task.priority !== 'string') task.priority = 'nízká';
                            });
                        });
                        importedData.events.forEach(item => item.id = Number(item.id) || Date.now());
                        importedData.ideas.forEach(item => item.id = Number(item.id) || Date.now());

                        data = importedData;
                        await saveDataToDB();
                        updateTable();
                        showCustomModal('Data byla úspěšně importována do centrálního záznamníku!', "Import dokončen");
                    } else {
                        showCustomModal('Chyba: Importovaný soubor nemá očekávaný formát pro osobní záznamník.', 'Chyba importu');
                    }
                } catch (e) {
                    console.error("Chyba při čtení JSON souboru:", e);
                    showCustomModal('Chyba při čtení JSON souboru: ' + e.message, 'Chyba importu');
                }
            };
            reader.readAsText(file);
        }

        // --- NOVÁ LOGIKA PRO KONTEXTOVÉ AKCE A KOMUNIKACI S MASÉRNOU ---
        
        /**
         * Zobrazí modální okno s akcemi pro nápad.
         * @param {object} idea Objekt nápadu.
         */
        function showIdeaActionsModal(idea) {
            lastFocusedElement = document.activeElement;
            const modal = document.getElementById('ideaActionsModal');
            const addPricelistBtn = document.getElementById('addIdeaToPricelistBtn');
            const addTodoBtn = document.getElementById('addIdeaToTodoBtn');
            const closeBtn = document.getElementById('closeIdeaActionsModalBtn');

            // Nastavení dat pro akce
            addPricelistBtn.onclick = () => sendToMasernaPricelist(idea);
            addTodoBtn.onclick = () => convertIdeaToTodo(idea);
            closeBtn.onclick = () => closeModal('ideaActionsModal');
            
            modal.style.display = 'flex';
            modal.setAttribute('aria-hidden', 'false');
            setTimeout(() => { modal.focus(); }, 100);
        }
        
        /**
         * Odešle nápad jako novou položku ceníku do databáze Masérny.
         * @param {object} idea Objekt nápadu.
         */
        function sendToMasernaPricelist(idea) {
            const masernaRequest = indexedDB.open(MASERNA_DB_NAME, MASERNA_DB_VERSION);

            masernaRequest.onsuccess = (event) => {
                const masernaDB = event.target.result;
                const transaction = masernaDB.transaction(['masernaData'], 'readwrite');
                const store = transaction.objectStore('masernaData');
                
                const getRequest = store.get('currentData');
                
                getRequest.onsuccess = () => {
                    const masernaData = getRequest.result ? getRequest.result.data : { clients: [], priceListItems: [], globalMassageHistory: [], voucherPurchases: [] };
                    
                    const newPriceListItem = {
                        id: Date.now().toString(),
                        year: new Date().getFullYear().toString(),
                        type: 'nová položka',
                        name: idea.title,
                        length: '?? min',
                        price: 0,
                        count: 0,
                        total: 0
                    };
                    
                    masernaData.priceListItems.push(newPriceListItem);
                    
                    const dataToSave = {
                        id: 'currentData',
                        data: masernaData
                    };
                    
                    const putRequest = store.put(dataToSave);
                    
                    putRequest.onsuccess = () => {
                        console.log('Nápad odeslán do ceníku Masérny.');
                        showCustomModal('Váš nápad **"' + idea.title + '"** byl úspěšně odeslán do ceníku v Masérně. Nezapomeňte tam doplnit detaily jako délku a cenu!', 'Odesláno do Masérny');
                    };
                    
                    putRequest.onerror = () => {
                        console.error('Chyba při ukládání do Masérny.');
                        showCustomModal('Nastala chyba při odesílání nápadu do Masérny. Zkuste to prosím znovu.', 'Chyba');
                    };
                };
            };
            
            masernaRequest.onerror = (event) => {
                console.error('Nepodařilo se otevřít databázi Masérny:', event.target.error);
                showCustomModal('Nelze odeslat nápad. Nepodařilo se připojit k databázi Masérny.', 'Chyba připojení');
            };
            closeModal('ideaActionsModal');
        }

        /**
         * Převede nápad na úkol a přidá ho do prvního dostupného To-Do listu.
         * @param {object} idea Objekt nápadu.
         */
        function convertIdeaToTodo(idea) {
            if (data.todos.length === 0) {
                showCustomModal('Nelze přidat úkol, protože nemáte žádný To-Do list. Vytvořte prosím nejdříve list.', 'Chyba');
                return;
            }
            const firstTodoList = data.todos[0];
            firstTodoList.tasks.push({
                id: Date.now(),
                type: 'todo_task',
                text: idea.title,
                dueDate: '',
                priority: 'střední',
                completed: false,
                clientId: idea.clientId || null
            });
            autoSave();
            closeModal('ideaActionsModal');
            showCustomModal('Váš nápad byl úspěšně přidán jako úkol do To-Do listu: **' + firstTodoList.name + '**', 'Úkol přidán');
            updateTable();
        }

        /**
         * Inicializuje aplikaci po načtení DOM.
         */
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await openDatabase();
                await loadClientsFromMasernaDB();
                await loadDataFromDB();
            } catch (e) {
                console.error("Nepodařilo se načíst data z databáze.", e);
            }
            
            document.querySelectorAll('th[data-sort]').forEach(header => {
                header.addEventListener('click', () => {
                    const tableId = header.closest('table').id;
                    const sortKey = header.getAttribute('data-sort');
                    sortTable(tableId, sortKey);
                });
            });

            document.getElementById('modalOkButton').addEventListener('click', () => {
                if(pendingConfirmCallback) {
                    pendingConfirmCallback();
                }
                closeCustomModal();
            });
            const cancelButton = document.getElementById('modalCancelButton');
            if (cancelButton) {
                cancelButton.addEventListener('click', closeCustomModal);
            }
            document.getElementById('customMessageModal').addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeCustomModal();
            });
            
            document.querySelectorAll('.btn-toggle-filter').forEach(button => {
                button.addEventListener('click', () => {
                    filterByType(button.dataset.filter);
                });
            });

            updateTable();
            filterByType('all');
        });
    </script>
</body>
</html>